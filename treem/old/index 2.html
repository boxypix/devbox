<!-- tree.html -->
<!doctype html>
<html lang="ru">
<head>
  <!-- Google tag (gtag.js). Ниже указан тег Google для этого аккаунта. Скопируйте и вставьте его в код каждой страницы сайта, сразу после элемента <head>. На каждую страницу можно добавить только один тег Google. -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-NLKEB0Y08V"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-NLKEB0Y08V');
  </script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Primary Meta Tags -->
  <title>Be My Widget - iOS app</title>
  <meta name="title" content="Дерево метрик B2C: связи, иерархия и советы" />
  <meta name="description" content="Понятный гид по иерархии метрик. Разбираем зависимости от охватов до Retention." />

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://sidorkin.dev/treem/" />
  <meta property="og:title" content="ерево метрик B2C: связи, иерархия и советы" />
  <meta property="og:description" content="Понятный гид по иерархии метрик. Разбираем зависимости от охватов до Retention." />
  <meta property="og:image" content="https://sidorkin.dev/treem/cover.jpg" />

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content="https://sidorkin.dev/treem/" />
  <meta property="twitter:title" content="Дерево метрик B2C: связи, иерархия и советы" />
  <meta property="twitter:description" content="Понятный гид по иерархии метрик. Разбираем зависимости от охватов до Retention." />
  <meta property="twitter:image" content="https://sidorkin.dev/treem/cover.jpg" />

  <!-- Meta Tags Generated with https://metatags.io -->

  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <style>
    @font-face {
      font-family: "Tilda Sans";
      src: url("fonts/TildaSans-Regular.woff") format("woff");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "Tilda Sans";
      src: url("fonts/TildaSans-Medium.woff") format("woff");
      font-weight: 500;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "Tilda Sans";
      src: url("fonts/TildaSans-Semibold.woff") format("woff");
      font-weight: 600;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "Tilda Sans";
      src: url("fonts/TildaSans-Bold.woff") format("woff");
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "Tilda Sans";
      src: url("fonts/TildaSans-ExtraBold.woff") format("woff");
      font-weight: 800;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "Tilda Sans";
      src: url("fonts/TildaSans-Black.woff") format("woff");
      font-weight: 900;
      font-style: normal;
      font-display: swap;
    }

    /* Cursor dark, фон чёрный, шрифт Tilda Sans */
    :root{
      --bg: #000000;
      --panel: #0d0d0d;
      --panel2: #141414;
      --line: #1f1f1f;
      --line-hover: #2a2a2a;
      --input-bg: #1a1a1a;
      --text: #ededed;
      --muted: #6e6e6e;
      --accent: #f1f1f1;
      --accent-hover: #ededed;
      --accent2: #c3c3c3;
      --danger: #f48771;
      --shadow: 0 2px 8px rgba(0,0,0,.6);
      --r: 16px;
      --sans: "Tilda Sans", ui-sans-serif, system-ui, -apple-system, sans-serif;
      --mono: "Tilda Sans", ui-sans-serif, system-ui, sans-serif;
      --graph-node-font-size: 8px;
      --graph-node-parent-font-size: 8px;
    }
    /* Кастомные скроллбары — тёмно-серые */
    * {
      scrollbar-width: thin;
      scrollbar-color: #424242 #1a1a1a;
    }
    *::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    *::-webkit-scrollbar-track {
      background: #1a1a1a;
      border-radius: 4px;
    }
    *::-webkit-scrollbar-thumb {
      background: #424242;
      border-radius: 4px;
    }
    *::-webkit-scrollbar-thumb:hover {
      background: #525252;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: var(--bg);
      color: var(--text);
    }
    .treeHead{
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      background: var(--panel2);
    }
    .treeHeadLogo{
      width: 44px;
      height: 44px;
      flex-shrink: 0;
      margin-right: 6px;

      object-fit: contain;
    }
    .treeHeadTitle{
      margin: 0;
      margin-bottom: 8px;
      font-size: 15px;
      font-weight: 900;
      letter-spacing: .3px;
    }
    .treeHeadSub{
      margin-top: 2px;
      font-size: 11px;
      color: var(--muted);
    }
    .search{
      flex:1;
      display:flex;
      gap:10px;
      align-items:center;
    }
    input[type="search"]{
      width: 100%;
      padding: 8px 12px;
      border-radius: var(--r);
      border: 1px solid var(--line);
      background: var(--input-bg);
      color: var(--text);
      outline: none;
    }
    input[type="search"]:focus{
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }
    input[type="search"]::placeholder{
      color: rgba(255, 255, 255, 0.174);
    }
    .btn{
      padding: 8px 12px;
      border-radius: var(--r);
      border: 1px solid var(--line);
      background: var(--panel2);
      color: var(--text);
      cursor: pointer;
      user-select: none;
    }
    .btn:hover{
      border-color: var(--line-hover);
      background: var(--line-hover);
    }
    .layout{
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 12px;
      padding: 12px;
      height: 100%;
      min-height: 100vh;
    }
    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow: hidden;
      min-height: 0;
    }
    .treeWrap{
      display:flex;
      flex-direction:column;
      min-height:0;
      height:100%;
    }
    .treeSearchRow{
      flex: 0 0 auto;
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 8px 10px;
      border-bottom: 1px solid var(--line);
      background: var(--panel2);
    }
    .treeSearchRow input[type="search"]{
      flex:1;
      min-width:0;
    }
    .treeSearchRow .btn{
      flex:0 0 auto;
      min-width:32px;
      padding:8px 10px;
    }
    .treeSearchRow .btn img{
      width: 12px;
      height: 12px;
      display: block;
    }
    .treeScroll{
      flex:1;
      min-height:0;
      overflow:auto;
      padding:8px 8px 12px;
    }
    .detailWrap{
      padding:14px;
      overflow:auto;
      height:100%;
    }
    .node{
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 6px 8px;
      border-radius: var(--r);
      cursor: pointer;
      border: 1px solid transparent;
      transition: background .15s ease, border-color .15s ease;
    }
    .node:hover{
      background: #1E1E1E;
      border-color: var(--line);
    }
    .node.active{
      background: #ffffff;
      border-color: var(--line-hover);
    }
    .node .dot{
      width: 10px; height: 10px;
      border-radius: 999px;
      margin-top: 4px;
      flex: 0 0 auto;
    }
    .node .meta{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
      flex:1;
    }
    .node .name{
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color: #000000;
    }
    .node[data-depth="0"] .name,
    .node[data-depth="1"] .name{
      font-weight: 700;
      color: #fff;
    }
    .node[data-depth="2"] .name{
      color: #C0C0C0;
    }
    .node.active .name{
      color: #000000;
    }
    .node .code{
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
    }
    .node.active .code{
      color: var(--muted);
    }
    .node .tog{
      font-family: var(--mono);
      color: var(--muted);
      padding: 0 6px;
      border: 1px solid var(--line);
      border-radius: var(--r);
      line-height: 18px;
      height: 20px;
      margin-top: 1px;
      flex: 0 0 auto;
      background: var(--input-bg);
    }
    .children{
      margin-left: 14px;
      padding-left: 10px;
      border-left: 1px dashed var(--line);
    }
    .badge{
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: var(--r);
      border: 1px solid var(--line);
      background: var(--panel2);
      color: var(--muted);
      font-size: 12px;
    }
    .badge strong{color:var(--text); font-weight:700}
    .relatedLinks{
      font-family: var(--mono);
      font-size: 15px;
      color: var(--muted);
    }
    .relatedLinks a{
      color: var(--accent2);
      text-decoration: none;
    }
    .relatedLinks a:hover{
      text-decoration: underline;
    }
    .h2{
      margin:0 0 16px 0;
      font-size:68px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .p{margin: 0 0 10px 0; color: var(--text); line-height: 1.5}
    .muted{color: var(--muted)}
    .grid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .box{
      border: 1px solid var(--line);
      border-radius: var(--r);
      padding: 12px;
      background: var(--panel2);
    }
    .box h3{
      margin:0 0 6px 0;
      font-size:12px;
      color: var(--muted);
      font-weight:600;
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    ul{margin: 0; padding-left: 18px}
    li{margin: 6px 0; color: var(--text); line-height: 1.45}
    .crumbs{
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 0 0 10px 0;
      align-items: center;
      justify-content: space-between;
    }
    .crumbsLinks{
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .crumbsRight{
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .crumbsSep{
      color: var(--muted);
      user-select: none;
      pointer-events: none;
    }
    .crumbsLinks a{
      color: var(--accent);
      text-decoration: none;
      font-size: 12px;
      border: 1px solid var(--line);
      background: var(--panel2);
      padding: 5px 9px;
      border-radius: var(--r);
    }
    .crumbsLinks a:hover{border-color: var(--accent); background: var(--input-bg)}
    .crumbsAuthor{
      border: none;
      background: transparent;
      color: #ffffffbd;
      padding: 0;
      font-size: 13px;
      cursor: pointer;
      text-decoration: none;
      padding-right: 12px;
    }
    .crumbsAuthor:hover{
      color: #ffffff;
      text-decoration: none;
    }
    .crumbsAuthor img{
      width: 14px;
      height: 14px;
      opacity: 0.6;
      display: inline-block;
      vertical-align: middle;
      margin-right: 4px;
      margin-bottom: 3px;
      transition: opacity .15s ease;
    }
    .crumbsAuthor:hover img{
      opacity: 1;
    }
    /* Кнопка «Нашел ошибку» — уникальный стиль: всегда белая заливка, чёрный текст */
    a.crumbsReportBtn,
    a.crumbsReportBtn:hover,
    a.crumbsReportBtn:focus,
    a.crumbsReportBtn:active,
    a.crumbsReportBtn:visited,
    a.crumbsReportBtn:focus-visible {
      display: inline-block;
      padding: 6px 12px;
      border-radius: var(--r);
      background: #ffffff !important;
      background-color: #ffffff !important;
      color: #000000 !important;
      font-size: 12px;
      font-weight: 700;
      text-decoration: none;
      border: 1px solid rgba(255,255,255,.4);
      margin-left: auto;
    }
    .empty{
      padding: 16px;
      color: var(--muted);
      font-size: 13px;
      border: 1px dashed var(--line);
      border-radius: var(--r);
      background: var(--panel2);
    }
    .footerNote{
      margin-top: 14px;
      font-size: 12px;
      color: var(--muted);
    }
    .metricGraph{
      margin: 0 0 16px 0;
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: var(--r);
      background: var(--panel2);
      overflow: auto;
    }
    .metricGraph h3{
      margin:0 0 10px 0;
      font-size:11px;
      color: var(--muted);
      font-weight:600;
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    .metricGraphSvg{
      display: block;
      width: 100%;
      min-height: 140px;
      background-image: url("bg1.png");
      background-repeat: repeat;
      opacity: 0;
      transition: opacity 500ms ease-out;
    }
    .rootTilesGrid{
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-auto-rows: 211px;
      gap: 12px;
    }
    @media (max-width: 1200px) {
      .rootTilesGrid{
        grid-template-columns: repeat(3, 1fr);
      }
    }
    @media (max-width: 400px) {
      .rootTilesGrid{
        grid-template-columns: repeat(2, 1fr);
      }
    }
    .rootTile{
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      gap: 4px;
      padding: 18px;
      height: 211px;
      box-sizing: border-box;
      border-radius: var(--r);
      border: 3px solid var(--line);
      background: var(--panel2);
      color: var(--text);
      text-decoration: none;
      transition: background .15s ease, border-color .15s ease, transform .15s ease;
    }
    .rootTileSpacer{
      flex: 1;
      min-height: 0;
    }
    .rootTileName{
      font-size: 17px;
      font-weight: 700;
      text-align: left;
    }
    .rootTileCode{
      font-size: 13px;
      font-weight: 400;
      text-align: left;
    }
    .rootTileIcon{
      width: 64px;
      height: 64px;
      object-fit: contain;
      flex-shrink: 0;
    }
    .rootTile:hover{
      border-color: var(--accent);
      background: var(--tile-bg-hover) !important;
      transform: scale(1.02);
    }
    .graphLink{
      stroke: #424242;
      stroke-width: 1.5;
      fill:none;
      opacity:.8;
    }
    .graphNode{
      cursor:pointer;
      transition: transform .15s ease, filter .15s ease;
    }
    .graphNode:hover{
      filter: brightness(1.2);
    }
    .graphNode rect{
      fill: var(--panel2);
      stroke: var(--line);
      stroke-width: 1.5;
      transition: stroke .15s ease, stroke-width .15s ease;
    }
    .graphNode:hover rect{
      stroke: var(--accent);
      stroke-width: 2;
    }
    .graphNode.active rect{
      stroke: var(--accent2);
      stroke-width: 2;
      filter: drop-shadow(0 0 6px rgba(86, 156, 214, .25));
    }
    .graphNode text{
      font: var(--graph-node-font-size) var(--mono);
      fill: var(--text);
      pointer-events: none;
      text-anchor: middle;
      dominant-baseline: central;
    }
    .graphNode.active text{
      fill: var(--accent2);
      font-weight: 700;
    }
    .graphNode.parent rect{
      fill: var(--panel);
      stroke: var(--line);
    }
    .graphNode.parent text{
      fill: var(--muted);
      font-size: var(--graph-node-parent-font-size);
    }
    .graphNode.parent:hover rect{
      stroke: var(--line-hover);
      fill: var(--input-bg);
    }
    .graphNode.parent:hover text{
      fill: var(--text);
    }
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr; height:auto}
      .card{min-height: 40vh}
    }

    /* Welcome popup */
    .welcomeOverlay{
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .welcomeOverlay.is-hidden{
      display: none;
    }
    .welcomeModal{
      display: flex;
      max-width: 780px;
      width: 100%;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--r);
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    .welcomeModalSplash{
      flex: 0 0 auto;
      width: 400px;
      height: 400px;
    }
    .welcomeModalSplash img{
      display: block;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .welcomeModalContent{
      display: flex;
      flex-direction: column;
      padding: 32px 28px;
      padding-top: 2px;
      min-width: 0;
      flex: 1;
    }
    .welcomeModalContent .welcomeModalBody{
      flex: 1;
      min-height: 0;
    }
    .welcomeModal h2{
      margin: 0 0 12px 0;
      font-size: 22px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: .2px;
    }
    .welcomeModal .welcomeBy{
      margin: 0 0 20px 0;
      font-size: 15px;
      color: #9a9a9a;
    }
    .welcomeModal .welcomeDesc{
      margin: 0 0 24px 0;
      font-size: 15px;
      line-height: 1.5;
      color: #fff;
    }
    .welcomeModal .welcomeBtn{
      display: block;
      width: 100%;
      padding: 14px 20px;
      border: none;
      border-radius: var(--r);
      background: #fff;
      color: #0d0d0d;
      font-family: var(--sans);
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
    }
    .welcomeModal .welcomeBtn:hover{
      background: #e8e8e8;
    }
  </style>
</head>

<body>
  <div class="welcomeOverlay" id="welcomeOverlay">
    <div class="welcomeModal">
      <div class="welcomeModalSplash">
        <img src="splash1.png" alt="" />
      </div>
      <div class="welcomeModalContent">
        <div class="welcomeModalBody">
          <h1>Добро пожаловать <br>в дерево метрик</h2>
          <p class="welcomeBy">by Vladimir Sidorkin © 2026 v1.0</p>
          <p class="welcomeDesc">Гайд по метрикам и системному анализу. Изучайте зависимости и советы по оптимизации. Бесплатно и без регистрации. Нашли ошибку? Напишите мне.</p>
        </div>
        <button type="button" class="welcomeBtn" id="welcomeBtn">Исследовать метрики</button>
      </div>
    </div>
  </div>

  <main class="layout">
    <section class="card">
      <div class="treeWrap">
        <div class="treeHead">
          <img class="treeHeadLogo" src="logo.png" width="26" height="26" alt="" />
          <div>
            <h1 class="treeHeadTitle">Дерево метрик (B2C)</h1>
            <div class="treeHeadSub">NSM → Acquisition → Activation → Engagement <br>→ Retention → Monetization</div>
          </div>
        </div>
        <div class="treeSearchRow">
          <input id="q" type="search" placeholder="Найти по названию или тегам…" autocomplete="off" />
          <button class="btn" id="expandAll" title="Развернуть всё"><img src="ico_expand.svg" alt="Развернуть" width="12" height="12" /></button>
          <button class="btn" id="collapseAll" title="Свернуть всё"><img src="ico_collapse.svg" alt="Свернуть" width="12" height="12" /></button>
        </div>
        <div class="treeScroll" id="tree"></div>
      </div>
    </section>

    <section class="card">
      <div class="detailWrap" id="detail">
        <div class="empty">Выбери метрику слева — справа появится описание, зачем важно и как улучшать.</div>
      </div>
    </section>
  </main>

  <script src="tree.data.js"></script>
  <script>
    const METRIC_TREE = window.METRIC_TREE;

    const $tree = document.getElementById("tree");
    const $detail = document.getElementById("detail");
    const $q = document.getElementById("q");
    const $countShown = document.getElementById("countShown");
    const $activeCode = document.getElementById("activeCode");
    const setCountShown = (v) => { if ($countShown) $countShown.textContent = v; };
    const setActiveCode = (v) => { if ($activeCode) $activeCode.textContent = v; };

    const state = {
      expanded: new Set(),
      activeId: null,
      flat: [],
      parentById: new Map(),
      nodeById: new Map(),
      childrenById: new Map(),
      lastQuery: ""
    };

    function encodeHtml(str){
      return (str == null ? "" : String(str))
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function renderFatal(message){
      const safe = encodeHtml(message);
      $tree.innerHTML = `<div class="empty">Ошибка загрузки дерева: ${safe}</div>`;
      $detail.innerHTML = `<div class="empty">Проверь структуру <code>METRIC_TREE</code> в этой странице.</div>`;
      setCountShown("0");
      setActiveCode("ERR");
    }

    function validateTree(root){
      const problems = [];
      const seen = new Set();

      function walk(node, path){
        if (!node || typeof node !== "object") {
          problems.push(`${path}: узел должен быть объектом`);
          return;
        }
        if (!node.id || typeof node.id !== "string") problems.push(`${path}: отсутствует string id`);
        if (!node.name || typeof node.name !== "string") problems.push(`${path}: отсутствует string name`);
        if (!node.code || typeof node.code !== "string") problems.push(`${path}: отсутствует string code`);
        if (node.id) {
          if (seen.has(node.id)) problems.push(`${path}: дублирующийся id "${node.id}"`);
          seen.add(node.id);
        }
        const kids = node.children ?? [];
        if (!Array.isArray(kids)) {
          problems.push(`${path}: children должен быть массивом`);
          return;
        }
        for (let i = 0; i < kids.length; i++) {
          const child = kids[i];
          const idHint = child && typeof child === "object" ? (child.id || `#${i}`) : `#${i}`;
          walk(child, `${path}/${idHint}`);
        }
      }

      walk(root, "root");
      return problems;
    }

    function indexTree(root){
      state.flat = [];
      state.parentById.clear();
      state.nodeById.clear();
      state.childrenById.clear();

      function walk(node, parentId){
        state.flat.push(node);
        state.nodeById.set(node.id, node);
        state.parentById.set(node.id, parentId ?? null);
        if (node.children?.length){
          state.childrenById.set(node.id, node.children.map(c => c.id));
          for (const ch of node.children) walk(ch, node.id);
        } else {
          state.childrenById.set(node.id, []);
        }
      }
      walk(root, null);
    }

    function normalize(s){ return (s || "").toString().trim().toLowerCase(); }

    function matchesQuery(node, q){
      if (!q) return true;
      const hay = [
        node.name, node.code, node.short, node.why,
        ...(node.tags || []),
      ].map(normalize).join(" ");
      return hay.includes(q);
    }

    function hasMatchingDescendant(nodeId, q){
      const kids = state.childrenById.get(nodeId) || [];
      for (const kidId of kids){
        const kid = state.nodeById.get(kidId);
        if (!kid) continue;
        if (matchesQuery(kid, q)) return true;
        if (hasMatchingDescendant(kidId, q)) return true;
      }
      return false;
    }

    function buildVisibleSet(q){
      const visible = new Set();
      for (const node of state.flat){
        const ok = matchesQuery(node, q);
        const descendantOk = hasMatchingDescendant(node.id, q);
        if (ok || descendantOk) visible.add(node.id);
      }
      return visible;
    }

    function renderTree(){
      const q = normalize(state.lastQuery);
      const visible = buildVisibleSet(q);

      let shownCount = 0;

      function renderNode(node, depth=0){
        if (!visible.has(node.id)) return "";

        shownCount++;

        const children = node.children || [];
        const hasChildren = children.length > 0;

        const shouldExpand = q
          ? (state.expanded.has(node.id) || hasMatchingDescendant(node.id, q))
          : state.expanded.has(node.id);

        const isActive = state.activeId === node.id;
        const branchId = getBranchId(node);
        const dotColor = BRANCH_COLORS[branchId] || BRANCH_COLORS.root;

        const tog = hasChildren
          ? `<span class="tog" data-tog="${node.id}" title="${shouldExpand ? "Свернуть" : "Развернуть"}">${shouldExpand ? "−" : "+"}</span>`
          : "";

        const html = `
          <div class="node ${isActive ? "active" : ""}" data-id="${node.id}" data-depth="${depth}">
            <span class="dot" style="opacity:${Math.max(0.35, 1 - depth*0.08)};background:${dotColor}"></span>
            <div class="meta">
              <div class="name" title="${escapeHtml(node.name)}">${escapeHtml(node.name)}</div>
              <div class="code">${escapeHtml(node.code || node.id)}</div>
            </div>
            ${tog}
          </div>
          ${hasChildren && shouldExpand
            ? `<div class="children">${children.map(ch => renderNode(ch, depth+1)).join("")}</div>`
            : ``}
        `;
        return html;
      }

      $tree.innerHTML = renderNode(METRIC_TREE);
      setCountShown(String(shownCount));
      wireTreeEvents();
    }

    function wireTreeEvents(){
      // Node click
      $tree.querySelectorAll(".node").forEach(el => {
        el.addEventListener("click", (e) => {
          const id = el.getAttribute("data-id");
          // If click on toggler, ignore here (handled below)
          if (e.target && e.target.getAttribute && e.target.getAttribute("data-tog")) return;
          setActive(id);
        });
      });

      // Toggle click
      $tree.querySelectorAll("[data-tog]").forEach(el => {
        el.addEventListener("click", (e) => {
          e.stopPropagation();
          const id = el.getAttribute("data-tog");
          toggleExpand(id);
        });
      });
    }

    function toggleExpand(id){
      if (state.expanded.has(id)) state.expanded.delete(id);
      else state.expanded.add(id);
      renderTree();
    }

    function expandAll(){
      for (const node of state.flat){
        if ((node.children || []).length) state.expanded.add(node.id);
      }
      renderTree();
    }

    function collapseAll(){
      // Свернуть только второй уровень; первый (root) оставить развёрнутым
      state.expanded.clear();
      state.expanded.add(METRIC_TREE.id);
      renderTree();
    }

    function getPath(id){
      const path = [];
      let cur = id;
      while (cur){
        const n = state.nodeById.get(cur);
        if (!n) break;
        path.push(n);
        cur = state.parentById.get(cur);
      }
      return path.reverse();
    }

    // Цвета второго уровня дерева (ветки): dot в списке + active нода в графе
    const BRANCH_COLORS = {
      root: "#E8E8E8",
      nsm: "#09B9FF",
      acq: "#5661FF",
      act: "#9E52FF",
      eng: "#FF4997",
      ret: "#FF723A",
      mon: "#FFCB3A",
      qual: "#81FF3C",
      ue: "#23FFC8"
    };
    function getBranchId(node){
      const path = getPath(node.id);
      return path.length > 1 ? path[1].id : "root";
    }
    function hexToRgba(hex, a){
      const m = hex.slice(1).match(/.{2}/g);
      if (!m) return `rgba(122,162,255,${a})`;
      const [r,g,b] = m.map(x => parseInt(x, 16));
      return `rgba(${r},${g},${b},${a})`;
    }

    function getNodeByCode(code){
      if (!code) return null;
      const c = String(code).trim().toLowerCase();
      for (const node of state.flat){
        const nodeCode = (node.code || node.id || "").toString().toLowerCase();
        if (nodeCode === c || (node.id && node.id.toLowerCase() === c)) return node;
      }
      return null;
    }

    function renderMetricGraph(node){
      const parentId = state.parentById.get(node.id) ?? null;
      const parent = parentId ? state.nodeById.get(parentId) : null;
      const children = state.childrenById.get(node.id) || [];
      const childNodes = children.map(id => state.nodeById.get(id)).filter(Boolean);
      const relatedCodes = node.related || [];
      const relatedNodes = relatedCodes.map(getNodeByCode).filter(Boolean);
      const seen = new Set([node.id]);
      const others = [];
      if (parent && !seen.has(parent.id)){ seen.add(parent.id); others.push({ n: parent, role: "parent" }); }
      childNodes.forEach(n => { if (!seen.has(n.id)){ seen.add(n.id); others.push({ n: n, role: "child" }); } });
      relatedNodes.forEach(n => { if (!seen.has(n.id)){ seen.add(n.id); others.push({ n: n, role: "related" }); } });
      if (others.length === 0 && !parent && childNodes.length === 0) return "";

      if (node.id === "root" && childNodes.length > 0) {
        const tiles = childNodes.slice(0, 8).map(n => {
          const hex = BRANCH_COLORS[getBranchId(n)] || BRANCH_COLORS.root;
          return `<a href="#" class="rootTile" data-id="${n.id}" style="border-color:${hex};color:${hex};background:${hexToRgba(hex, 0.10)};--tile-bg-hover:${hexToRgba(hex, 0.28)}"><img class="rootTileIcon" src="ic/${(n.code || n.id).toUpperCase()}.svg" alt="" width="24" height="24" /><span class="rootTileSpacer"></span><span class="rootTileName">${escapeHtml(n.name || n.id)}</span><span class="rootTileCode">${escapeHtml(n.code || n.id)}</span></a>`;
        });
        return `
        <div class="metricGraph">
          <h3>Связи метрик</h3>
          <div class="rootTilesGrid">${tiles.join("")}</div>
        </div>
        `;
      }

      const nodeW = 115;
      const padX = 12;
      const padY = 6;
      const lineHeight = 14;
      const charsPerLine = 26;

      function wrapLabel(text){
        const words = text.trim().split(/\s+/);
        const lines = [];
        let line = "";
        for (const word of words){
          const next = line ? line + " " + word : word;
          if (next.length <= charsPerLine){
            line = next;
          } else {
            if (line) lines.push(line);
            line = word.length <= charsPerLine ? word : word.slice(0, charsPerLine - 1) + "‑";
          }
        }
        if (line) lines.push(line);
        return lines.length ? lines : [""];
      }

      function nodeSize(n){
        const raw = (n.name || n.code || n.id).trim();
        const lines = wrapLabel(raw);
        const h = padY * 2 + lines.length * lineHeight;
        return { lines, w: nodeW, h };
      }

      let leftNodes, rightNodes;
      if (node.id === "root") {
        // Верхний уровень: только ноды второго уровня (как в treeScroll), пополам слева и справа
        const all = others.filter(x => x.role === "child").map(x => x.n);
        const half = Math.ceil(all.length / 2);
        leftNodes = all.slice(0, half);
        rightNodes = all.slice(half);
      } else {
        leftNodes = others.filter(x => x.role === "parent").map(x => x.n);
        rightNodes = [...others.filter(x => x.role === "child").map(x => x.n), ...others.filter(x => x.role === "related").map(x => x.n)];
      }

      const colLeft = 90;
      const colCenter = 270;
      const colRight = 450;
      const totalW = 540;
      // Между нод: вертикальный шаг между нодами (меньше — плотнее)
      const rowStep = 30;
      const totalH = Math.max(100, 40 + Math.max(leftNodes.length, rightNodes.length + 1) * rowStep);

      const positions = new Map();
      const nodeInfo = new Map();

      function placeNode(n, x, y){
        const { lines, w, h } = nodeSize(n);
        nodeInfo.set(n.id, { x, y, w, h, lines });
        positions.set(n.id, { x, y, w, h });
      }

      const cy = totalH / 2;
      placeNode(node, colCenter, cy);

      leftNodes.forEach((n, i) => {
        const y = leftNodes.length === 1 ? cy : 28 + (i / Math.max(1, leftNodes.length - 1)) * (totalH - 56);
        placeNode(n, colLeft, y);
      });

      rightNodes.forEach((n, i) => {
        const y = rightNodes.length === 1 ? cy : 28 + (i / Math.max(1, rightNodes.length - 1)) * (totalH - 56);
        placeNode(n, colRight, y);
      });

      const edges = [];
      if (parent) edges.push({ from: parent.id, to: node.id });
      leftNodes.forEach(n => edges.push({ from: node.id, to: n.id }));
      rightNodes.forEach(n => edges.push({ from: node.id, to: n.id }));

      const allNodes = [node, ...leftNodes, ...rightNodes];
      const lines = edges.map(e => {
        const a = nodeInfo.get(e.from);
        const b = nodeInfo.get(e.to);
        if (!a || !b) return "";
        const x1 = a.x + a.w / 2;
        const y1 = a.y;
        const x2 = b.x - b.w / 2;
        const y2 = b.y;
        return `<line class="graphLink" x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}"/>`;
      }).join("");

      const parentIdForClass = parent ? parent.id : null;
      const activeBranchColor = BRANCH_COLORS[getBranchId(node)] || BRANCH_COLORS.root;
      const nodeEls = allNodes.map(n => {
        const info = nodeInfo.get(n.id);
        if (!info) return "";
        const isActive = n.id === node.id;
        const isParent = n.id === parentIdForClass;
        const branchColor = BRANCH_COLORS[getBranchId(n)] || BRANCH_COLORS.root;
        const rectStroke = isActive ? activeBranchColor : isParent ? hexToRgba(branchColor, 0.4) : branchColor;
        const fill = isActive ? rectStroke : isParent ? "rgba(13,13,13,.95)" : hexToRgba(branchColor, 0.12);
        const strokeWidth = isActive ? 2 : 1.5;
        const textFill = isActive ? "#000000" : hexToRgba(branchColor, 0.9);
        const classes = ["graphNode", isActive ? "active" : "", isParent ? "parent" : ""].filter(Boolean).join(" ");
        const { x, y, w, h, lines } = info;
        const rx = 8;
        const startY = -((lines.length - 1) * lineHeight) / 2;
        const tspans = lines.map((line, i) =>
          `<tspan x="0" dy="${i === 0 ? startY : lineHeight}" text-anchor="middle">${escapeHtml(line)}</tspan>`
        ).join("");
        const rectStyle = `stroke:${rectStroke};stroke-width:${strokeWidth};fill:${fill}` + (isActive ? `;filter:drop-shadow(0 0 16px ${hexToRgba(activeBranchColor, 0.9)})` : "");
        const textStyle = `fill:${textFill}` + (isActive ? ";font-weight:700" : "");
        return `<g class="${classes}" data-id="${n.id}" transform="translate(${x},${y})">
          <rect x="${-w/2}" y="${-h/2}" width="${w}" height="${h}" rx="${rx}" ry="${rx}" fill="#000000"/>
          <rect x="${-w/2}" y="${-h/2}" width="${w}" height="${h}" rx="${rx}" ry="${rx}" style="${rectStyle}"/>
          <text y="0" dy="0" style="${textStyle}">${tspans}</text>
        </g>`;
      }).join("");

      return `
        <div class="metricGraph">
          <h3>Связи метрик</h3>
          <svg class="metricGraphSvg" viewBox="0 0 ${totalW} ${totalH}" xmlns="http://www.w3.org/2000/svg">
            ${lines}
            ${nodeEls}
          </svg>
        </div>
      `;
    }

    function setActive(id){
      state.activeId = id;
      const node = state.nodeById.get(id);
      if (!node) return;

      // Ensure parents expanded so selection stays visible
      const path = getPath(id);
      for (const p of path){
        if ((p.children || []).length) state.expanded.add(p.id);
      }

      setActiveCode(node.code || node.id);

      // Обновить URL: выбранная метрика в hash (на англ. коде)
      const code = (node.code || node.id).toLowerCase().replace(/^#/, "");
      const newHash = code && node.id !== "root" ? "#" + code : "";
      const url = location.pathname + (newHash ? newHash : "") + (location.search || "");
      history.replaceState({ metric: code }, "", url);

      $detail.innerHTML = renderDetail(node);

      // Плавное появление графа метрик
      requestAnimationFrame(() => {
        const svg = $detail.querySelector(".metricGraphSvg");
        if (svg) {
          // сброс на 0 и следующая рамка для гарантированного старта анимации
          svg.style.opacity = "0";
          requestAnimationFrame(() => {
            svg.style.opacity = "1";
          });
        }
      });

      renderTree();
    }

    function getMetricFromUrl(){
      const hash = (location.hash || "").trim().replace(/^#/, "");
      return hash || null;
    }

    function renderDetail(node){
      const path = getPath(node.id);
      const graphHtml = renderMetricGraph(node);

      const crumbLinks = path.map(p => {
        const hex = BRANCH_COLORS[getBranchId(p)] || BRANCH_COLORS.root;
        return `<a href="#" data-jump="${p.id}" style="color:${hex};border-color:${hex}">${escapeHtml(p.code || p.id)}</a>`;
      }).join('<span class="crumbsSep" aria-hidden="true">→</span>');
      const crumbs = `
        <div class="crumbs">
          <div class="crumbsLinks">${crumbLinks}</div>
          <div class="crumbsRight">
            <a
              href="https://www.linkedin.com/in/vladimir-sidorkin/"
              class="crumbsAuthor"
              target="_blank"
              rel="noopener noreferrer"
            >
            <img src="ico_li.png" alt="" />
              Vladimir Sidorkin © 2026
              
            </a>
            <a href="https://t.me/boxypix" target="_blank" class="crumbsReportBtn">Нашел ошибку</a>
          </div>
        </div>
      `;

      const tagHex = BRANCH_COLORS[getBranchId(node)] || BRANCH_COLORS.root;
      const tags = (node.tags || []).length
        ? `<div class="footerNote">Теги: <span style="color:${tagHex}">${(node.tags || []).map(escapeHtml).join(", ")}</span></div>`
        : "";

      const formula = node.formula
        ? `<div class="box"><h3>Формула</h3><div class="p" style="margin:0;font-family:var(--mono)">${escapeHtml(node.formula)}</div></div>`
        : "";

      const improve = (node.howImprove || []).length
        ? `<ul>${node.howImprove.map(x => `<li>${escapeHtml(x)}</li>`).join("")}</ul>`
        : `<div class="muted">—</div>`;

      const pitfalls = (node.pitfalls || []).length
        ? `<ul>${node.pitfalls.map(x => `<li>${escapeHtml(x)}</li>`).join("")}</ul>`
        : `<div class="muted">—</div>`;

      const related = (node.related || []).length
        ? `<div class="relatedLinks">${(node.related || []).map(code => {
            const safe = escapeHtml(code);
            return `<a href="#" data-related="${safe}">${safe}</a>`;
          }).join(", ")}</div>`
        : `<div class="muted">—</div>`;

      const body = `
        ${crumbs}
        ${graphHtml}

        <h2 class="h2">${escapeHtml(node.name)}</h2>
        <p class="p muted">${escapeHtml(node.short || "")}</p>

        <div class="grid">
          <div class="box">
            <h3>Важность</h3>
            <p class="p" style="margin:0">${escapeHtml(node.why || "—")}</p>
          </div>
          ${formula || `<div class="box"><h3>Формула</h3><div class="muted">—</div></div>`}
        </div>

        <div class="grid" style="margin-top:10px">
          <div class="box">
            <h3>Как улучшать</h3>
            ${improve}
          </div>
          <div class="box">
            <h3>Ловушки</h3>
            ${pitfalls}
          </div>
        </div>

        <div class="box" style="margin-top:10px">
          <h3>Связанные метрики</h3>
          ${related}
        </div>

        ${tags}
      `;

      // wire breadcrumbs, graph nodes и связанные метрики
      setTimeout(() => {
        $detail.querySelectorAll("[data-jump]").forEach(a => {
          a.addEventListener("click", (e) => {
            e.preventDefault();
            setActive(a.getAttribute("data-jump"));
          });
        });
        $detail.querySelectorAll(".graphNode[data-id]").forEach(el => {
          el.addEventListener("click", () => setActive(el.getAttribute("data-id")));
        });
        $detail.querySelectorAll(".rootTile[data-id]").forEach(el => {
          el.addEventListener("click", (e) => {
            e.preventDefault();
            setActive(el.getAttribute("data-id"));
          });
        });
        $detail.querySelectorAll("[data-related]").forEach(a => {
          a.addEventListener("click", (e) => {
            e.preventDefault();
            const code = a.getAttribute("data-related");
            const target = getNodeByCode(code);
            if (target) setActive(target.id);
          });
        });
      }, 0);

      return body;
    }

    function escapeHtml(str){
      return encodeHtml(str);
    }

    // Search
    let t = null;
    $q.addEventListener("input", () => {
      clearTimeout(t);
      t = setTimeout(() => {
        state.lastQuery = $q.value;
        renderTree();
      }, 80);
    });

    document.getElementById("expandAll").addEventListener("click", expandAll);
    document.getElementById("collapseAll").addEventListener("click", collapseAll);

    const welcomeOverlay = document.getElementById("welcomeOverlay");
    const WELCOME_SEEN_KEY = "treemWelcomeSeen";
    if (localStorage.getItem(WELCOME_SEEN_KEY) && welcomeOverlay) {
      welcomeOverlay.classList.add("is-hidden");
    }
    document.getElementById("welcomeBtn").addEventListener("click", () => {
      try { localStorage.setItem(WELCOME_SEEN_KEY, "1"); } catch (_) {}
      if (welcomeOverlay) welcomeOverlay.classList.add("is-hidden");
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "i" || e.key === "I") {
        const active = document.activeElement;
        if (active && (active.tagName === "INPUT" || active.tagName === "TEXTAREA")) return;
        if (welcomeOverlay) welcomeOverlay.classList.remove("is-hidden");
      }
    });

    try {
      if (!METRIC_TREE) {
        throw new Error("METRIC_TREE не найден. Убедись, что tree.data.js подключен до main script.");
      }

      const problems = validateTree(METRIC_TREE);
      if (problems.length) {
        throw new Error(`Некорректная структура: ${problems[0]}`);
      }

      // Init
      indexTree(METRIC_TREE);

      // Default expand: top-level branches
      for (const child of (METRIC_TREE.children || [])) state.expanded.add(child.id);
      state.expanded.add(METRIC_TREE.id);

      renderTree();

      // При загрузке: если в URL есть метрика (hash) — выбрать её, иначе root
      const metricFromUrl = getMetricFromUrl();
      const nodeFromUrl = metricFromUrl ? getNodeByCode(metricFromUrl) : null;
      if (nodeFromUrl) setActive(nodeFromUrl.id);
      else setActive(METRIC_TREE.id);
    } catch (err) {
      renderFatal(err && err.message ? err.message : String(err));
      console.error(err);
    }
  </script>
</body>
</html>
